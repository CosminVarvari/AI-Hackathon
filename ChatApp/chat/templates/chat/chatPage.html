<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Londrina+Sketch&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Translator Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('/images/background.jpg');
      background-size: cover;
      color: #333;
      margin: 0;
      padding: 0;
    }

    h1 {
      color: #4a90e2;
      font-size: 3em;
      font-family: 'Londrina Sketch', cursive;
      margin-bottom: 20px;
    }

    .container {
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .chat__item__container {
      margin-top: 20px;
    }

    input[type="text"] {
      width: 70%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-right: 10px;
    }

    button {
      background-color: #4a90e2;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #357ab8;
    }

    #language_select {
      margin-bottom: 15px;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .message {
      padding: 10px;
      background-color: #e1f5fe;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .logout-link {
      display: inline-block;
      margin-top: 10px;
      text-decoration: none;
      color: #4a90e2;
    }

    .logout-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <center><h1>Translator Chat</h1></center>
    <br>
    <div class="chat__item__container" id="id_chat_item_container">
      <select id="language_select">
        <option value="en">English</option>
        <option value="fr">French</option>
        <option value="es">Spanish</option>
        <option value="de">German</option>
        <option value="it">Italian</option>
        <option value="pt">Portuguese</option>
        <option value="ru">Russian</option>
        <option value="zh">Chinese (Simplified)</option>
        <option value="ja">Japanese</option>
        <option value="ko">Korean</option>
        <option value="ar">Arabic</option>
        <option value="hi">Hindi</option>
        <option value="bn">Bengali</option>
        <option value="tr">Turkish</option>
        <option value="nl">Dutch</option>
        <option value="pl">Polish</option>
        <option value="sv">Swedish</option>
        <option value="no">Norwegian</option>
        <option value="fi">Finnish</option>
        <option value="ro">Romanian</option>
      </select>

      <button id="translate_button">Translate Messages</button>
      <br />
      <input type="text" id="id_message_send_input" placeholder="Type your message here..." />
      <button type="submit" id="id_message_send_button">Send Message</button>
      <br /><br />
    </div>
  </div>

  <script>
    let chatMessages = [];
    const chatSocket = new WebSocket("ws://" + window.location.host + "/");

    chatSocket.onopen = function (e) {
      console.log("The connection was setup successfully!");
    };
    chatSocket.onclose = function (e) {
      console.log("Something unexpected happened!");
    };

    document.querySelector("#id_message_send_input").focus();
    document.querySelector("#id_message_send_input").onkeyup = function (e) {
      if (e.keyCode == 13) {
        document.querySelector("#id_message_send_button").click();
      }
    };

    document.querySelector("#id_message_send_button").onclick = function (e) {
      var messageInput = document.querySelector("#id_message_send_input").value;
      chatSocket.send(JSON.stringify({ message: messageInput, username: "{{request.user.username}}" }));
    };

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      var div = document.createElement("div");
      div.classList.add('message');
      div.innerHTML = data.username + ": " + data.message;
      document.querySelector("#id_message_send_input").value = "";
      chatMessages.push({ username: data.username, message: data.message });
      document.querySelector("#id_chat_item_container").appendChild(div);
      console.log("All messages so far:", chatMessages);
    };

    function translateChatMessages(language) {
      fetch("/translate_chat/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({
          messages: chatMessages,
          language: language
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log("Translated messages response:", data);

        if (data.translated_messages) {
          console.log("Translated messages:", data.translated_messages);

          document.querySelector("#id_chat_item_container").innerHTML = "";
          data.translated_messages.forEach(message => {
            var div = document.createElement("div");
            div.classList.add('message');
            div.innerHTML = message.username + ": " + message.message;
            document.querySelector("#id_chat_item_container").appendChild(div);
          });
        } else {
          console.error("No translated messages found in response");
        }
      })
      .catch(error => console.error("Error:", error));
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    document.querySelector("#translate_button").addEventListener("click", function () {
      const selectedLanguage = document.querySelector("#language_select").value;
      translateChatMessages(selectedLanguage);
    });
  </script>
</body>
</html>
